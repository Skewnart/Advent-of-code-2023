using System;
using System.Collections.Generic;
using System.Globalization;
using System.Linq;
using System.Runtime.ExceptionServices;
using System.Text;
using System.Threading.Tasks;

namespace AdventOfCode.Puzzle
{
    public static partial class Extensions
    {
        public static string GetPrettyBoard(this int[,] board, bool reeeaaaallyprettyomg = false, int modulo = 0)
        {
            StringBuilder sb = new StringBuilder();

            for (int i = 0; i < board.GetLength(0); i++)
            {
                for (int j = 0; j < board.GetLength(1); j++)
                    sb.Append($"{(reeeaaaallyprettyomg ? (board[i, j] == -2 ? "#" : (board[i, j] == -1 ? "." : (board[i, j] % 2 == modulo ? "O" : "."))) : board[i, j])}".PadLeft(4));
                sb.Append("\n");
            }
            sb.Remove(sb.Length - 1, 1);
            return sb.ToString();
        }
        public static int ExecuteBFSFor(this int[,] board, int turn)
        {
            int modulosearched = turn % 2;
            int sum = modulosearched == 0 ? 1 : 0;

            List<int[]> queue = new List<int[]>();

            for (int i = 0; i < board.GetLength(0); i++)
                for (int j = 0; j < board.GetLength(1); j++)
                    if (board[i, j] == 0) queue.Add(new int[] { i, j });

            while(queue.Count > 0)
            {
                int[] next = queue.First();
                queue.RemoveAt(0);
                int value = board[next[0], next[1]];

                foreach (int[] adj in GetAdjacentTiles(board, next)) {
                    board[adj[0], adj[1]] = value + 1;
                    if ((value + 1) % 2 == modulosearched) sum++;

                    if (value + 1 < turn)
                    {
                        queue.Add(adj);
                    }
                }
            }

            return sum;
        }

        public static IEnumerable<int[]> GetAdjacentTiles(this int[,] board, int[] tocheck)
        {
            if (IsTrueEmptyNeighbor(board, tocheck[0] - 1, tocheck[1])) yield return new int[] { tocheck[0] - 1, tocheck[1] };
            if (IsTrueEmptyNeighbor(board, tocheck[0], tocheck[1] + 1)) yield return new int[] { tocheck[0], tocheck[1] + 1 };
            if (IsTrueEmptyNeighbor(board, tocheck[0] + 1, tocheck[1])) yield return new int[] { tocheck[0] + 1, tocheck[1] };
            if (IsTrueEmptyNeighbor(board, tocheck[0], tocheck[1] - 1)) yield return new int[] { tocheck[0], tocheck[1] - 1 };
        }

        public static bool IsTrueEmptyNeighbor(this int[,] board, int x, int y)
        {
            if(x < 0 || x >= board.GetLength(0) || y < 0 || y >= board.GetLength(1)) return false;
            return board[x, y] == -1;
        }
    }
    public class Day21 : IDayPuzzle
    {
        public string ExecutePart1()
        {
            int turn = 64;
            int modulosearched = turn % 2;

            int[,] board = G.GetInput();
            board.ExecuteBFSFor(turn);

            long sum = 0;
            for (int i = 0; i < board.GetLength(0); i++)
                for (int j = 0; j < board.GetLength(1); j++)
                    if (board[i, j] >= 0 && board[i, j] % 2 == modulosearched) sum++;

            return sum.ToString();
        }
        public string ExecutePart2()
        {
            const long stepsrequested = 26501365;

            List<long> sums = new List<long>();
            int[,] board = G.GetInput();
            int[,] fiveboards = new int[board.GetLength(0)*5, board.GetLength(1) * 5];
            //5 car : 1 board pour un try classique, 1 + 2 * 1 board pour un try de deux longueurs, 1 + 2 * 2 pour un try de trois longueurs

            for (int f1 = 0; f1 < 5; f1++)
            {
                for (int f2 = 0; f2 < 5; f2++)
                {
                    for (int i = 0; i < board.GetLength(0); i++)
                        for (int j = 0; j < board.GetLength(1); j++)
                        {
                            int value = board[i, j];
                            if (value == 0 && (f1 != 2 || f2 != 2))
                                value = -1;
                            fiveboards[f1 * board.GetLength(0) + i, f2 * board.GetLength(1) + j] = value;
                        }
                }
            }

            //nb de boards attégnables (pour le calcul de la fonction quadratique)
            long reachableboards = stepsrequested / board.GetLength(0);
            //Puisqu'on peut pas faire autant d'itérations, on va faire les 3 premiers et extrapoler la fonction quadratique (le minimum donc)

            //nb de steps en interne dans le dernier board (la quadra va calculer le reste)
            long internalsteps = stepsrequested - reachableboards * board.GetLength(0);
            //On se rend compte qu'outre rejoindre l'infinité de boards, il nous reste 65 steps qui ne nous permettent pas de rejoindre un nouveau board.
            //On fait donc le test en partant du premier board, puis pareil en ayant atteint le deuxième en faisant le même nombre de step (65, 65 + 131, 65 + 131 + 131)
            //Puis calcul de quadra

            for (int n = 0; n < 3; n++)
            {
                var clone = (int[,])fiveboards.Clone();
                var sum = clone.ExecuteBFSFor((int)internalsteps + n * board.GetLength(0));

                sums.Add(sum);
            }

            long a0 = sums[0];
            long a1 = sums[1] - a0;
            long a2 = sums[2] - a1;
            //Ma quadra est un peu pété, j'ai fini par aller chercher un calcul de polynome en ligne avec les 3 résultats que j'ai trouvé en fonction de x pour me donner A B et C
            // Ce qui me donne : 3738 + 14836 * 202300 + 14696 * 202300^2 = 601441063166538
            return (a0 + a1 * reachableboards + (reachableboards * (reachableboards - 1) / 2) * (a2 - a1)).ToString(); // C'est ça qu'est pété du coup
        }

        public static class G
        {
            public static int[,] GetInput()
            {
                string[] input = INPUT.Split("\r\n").ToArray();
                int[,] board = new int[input.Length, input[0].Length];

                for(int i = 0; i < input.Length; i++)
                {
                    for(int j = 0; j < input[i].Length; j++)
                    {
                        char car = input[i][j];
                        board[i, j] = car == '.' ? -1 : (car == '#' ? -2 : 0);
                    }
                }

                return board;
            }

            public static readonly string INPUTTEST =
@"...........
.....###.#.
.###.##..#.
..#.#...#..
....#.#....
.##..S####.
.##..#...#.
.......##..
.##.#.####.
.##..##.##.
...........";

            public static readonly string INPUT =
    @"...................................................................................................................................
.#.###.......#.##...........................#...#....#.#.#.#...........#.......##....#.#.........#....#....#.........##.##.....#...
.#.......#.......#.....#...............#..#.#.#....#......#..............###.....#...........#...#......##..............#......#.#.
................#....................#.......#...#......................#..................#...#.........#.......###...........##..
..#..###...........#.##....#..........#...........##..#.#............................#........#..#.#.#..#....#..#...#...##......##.
..........#.....##....#........#......#........#...#..#.............................#........#.#.....#....#..#.#....#...#......#.#.
....#..........##.....#...........#..........#....................#...........#.........#.....#.#...#..##.........#.......#........
.......#.#..#.####....................#.#...#.....#.................#...........#....#...........#....##......#....................
..##......#.#..#.#...#..............#.........#....#................#........#.#...#.........#..................#........#.#..#....
....#.#.#.........#..#..............#.#......#................................#......#.....#....##.............##..#....#....#...#.
..#.................#.#.#.......#...#........#................#.#...............................#..#.#.......#.......#.......#.....
.#...#.#.#....................#..#......#...#.#...........#....##.......#.......#...........#............#.#.##......#..#..........
..#.....##............#..#...#..........#..#...#.........#...#........#............##...#....#...........#..#......#.....#.##.#....
...............#.#..#.#.....#......##.#.......##..............##..........................#........#.....#.#....#.....#.....#......
...........#...#.#....#.....#........##..................#..#......#.##....#........#.#..#.#...............#.#.........#.....#.....
..............##.....#..#.......#.........#..............##........................................#..#...##....#.........#.#......
.#.........#.#.......##......#...#...#...............##....##......####...#..................#............##.......#..#.##..#......
......#.......#............##.#....#......................#.............#...#.#.........##................#.#.............#...#.#..
........#.#........##............#...#...............#.#....##..............#...............#.................#.#..#.#.....#.#...#.
...#......#....#....#....#..#......#....................##..#............#..#...........#.......................#......##......#...
.............##.....#..#.##............#.............##......#......#..#..#..#...............#.............#..#.......##...........
............##.#...#..........................................#............#.................##.......##....#.........#..#.#.......
...##.#.##..#......#.......##......#.#............#.#.....#............#.##...................#.............#..###..#.#....#....##.
......#......#................##....##.................#..#.#.#.#....#.......#...............#...............#..........#...##.....
....#.................#..........##..........##....#..#........#.........##.#.....................###......#..............#..#.....
.###.............#.#........................................#.#.#..#...#.......................#.###...........###....#.......#..#.
..#...#..#........#...#.........#...........#....#....#.#...#.#....#...#.#...........................###.....#....#...#.....#......
..#.......##.....#.#...#.......#..........#.#.......#...#..#.#.........#.............#.............#.....##..##.........#..........
..........#......#..#.....#..............#..#...#.#.#...#.#...#...#...#..............................##..#...####.##...##..........
.....#..............#..........##............#.#..#.......#.#...#...##.##....#.......##...#............#.#............#.....#....#.
.#........#..............#..............#..###....#...#......#..........#.............#..............#...#...#.#........#..........
...............#.#....#...................#........##..#..##..............#.#..............................###....#.....#....#.....
......#.#.........#.......#...............#....#.#..#..###.#.........#..#...#......#..#..#...........#.......##......#..#......#...
.#..................##..#...........#.##.....#....#....................#.....#........###..............#.....##.....##....#..#.....
.#...#..#..............#.#.........#............#....#....##..........##..#.......#.####....##.#.....................#.............
......#............#....##...........#...........##........#...#...#.....................###.#...........#.............#........#..
...................##.............................#.#....#...#.....#..#......#............#.................#......#.....#.#.#.....
...........#..#........#..........##....#.........##..#........#...#.#..#...#.............#....#.............#.#..#...........#.##.
...#.........##......................#.#..........##...#.#..##......#...#...................#.#.#...............###............#.#.
.....#..#......................#.#.................#..#.........#.#.........#...#...#..##...#.....#.#..................#...........
.#..............................#......#..............####...........#...#.#........##.............................##....#.........
...................#.........#.....#......#.#.................#.#...#..#............#......#........##..............#.#.#..........
.......#.#.#...............#.#..#..##..............#..#.#...##.........#.#......##.....................#.......#.............#.....
..#...#.#...#......................#....#...##..#.......##...#.........#......###...##...#...........................#.............
................#..............##............#.......#..........#.......#..........#..................#..............#...#.........
...#.#.........#....................#................#..........#....#...#..#.......##..#....#..##.........................##......
.#..#....##.................#..........#...#.....#....#.......#.#..#......#...#.................#.......###..........#.....#..#.#..
....#....#............#....#.#...##.###..........#.......#...##.#...#...................##......#..#......#...............#........
.........#...................#........#....#...#....##......#.....#.#..#.#......#..#.##....#.....#.....#.....#..................##.
.....................#.....#...............###.................#......#...###.##.........#..#....#......#.............#....###..#..
......................#......#..#.......#...#...###..#........##..........#...#...........#.....##.........#.#.#...................
..#..................#............#.#..#....#.#...............#..............##.....#..#......#.#..##.......#..............##......
............................#.........#.....#.#..........#.............###.....#..##...#.#...#...#....#.....#...............#......
......#.....................#....#...#............#.....#..............##........#......#.#.......###.......#...#.........#..#.....
.......#.........#.#..#........##.#....#...#...#...#.......#....#........#...###.##..#.......#......#......................#.......
...#............##.....#..#.......#......#...#...#.......#..#..#......#....#.....#.................#...#.......#.............#.....
..##.................#...#.#...............###..###.....#...#........#......#.........#.#..##.#...#....#....#.......#..............
....#...........##.................#..........................#.....#...............#.............#.......#........#...............
...........#.....#......#........#.......#.......#......#..............................#..#...#.....#..........................#...
..#............#.#.....##......#.#...###.#.....#.##....#.......................#........##............#.......#.#.#................
...........#...........#.......#......#.....#.##.#.........#............#......#...#..#.#.........###..#...#.#.#.......#...........
.........##.....#..........#..........#.........#..........#...#..........#...............#...........#.#.......#..................
.........#.....#.............#.............#.#.#...#.##.......#.#...#....#.#............#.........#.#...........##.....#...........
..........#.....................##....#.....#...#.#..#.#.............#..#.#......#..............##....#...............#............
..........#.#...#..#..............#....##.....#....#.#.......#..#.#.............#...........#.......#..........#......#..#...#.....
.................................................................S.................................................................
..........###....................................#.......###........#........#....#.................###........#...................
......##......#...#....#.....#...#....#..#...#.....#...#..............#.......#.#.#.#...###.#......#..#..#....#.......#..#.........
..........#...#...........#.#.#.##.#...................#..........####.......#.###.#.......#.....#.###....#...#..#.##......#.......
...........#................#....#....#.......#.................#.......#...#............#...#..............#..##..................
..................#.............................##...#...##..#...........#.........#.#....#...........#.....#..........#.#.........
................#.......#.#...##.###.....#....#...#.........#.#...........#.#.......##.#...#....#.......#..#.##....#...#...........
..............##..#.#....#...#..............##.......#....................#....#....#.#.##....#.......#..#..#......#..#..........#.
....#..............##..#.#...##.....#............##.#...#..#..........#.#...###................#.......#..##..#....................
...............#..#.........................#...............#......#...#.................#..#.....#....#.#.##..#................#..
....#................#..#.........#....#..#....#..........#.#.....##............###........##..........#.....#.................#...
...#......................#.......#....#..............#.........#..........#...#....#...............##..#...................#..#...
.#...#...................#....#........#...#......##....##..#...#............#...#.#.#......#.#..#......##.................#...#...
...#..................#......#...#.#......#......#..###..##.#.....#...#..##.................#.#.#.##.......##....#..........#......
.........##..............#.................##...............#..#......#.#.......#..#....................#.....#....................
.....#....#............#......##...#.......##.....#...............#....#..#...#.............#................#................#.##.
........................##.....#.....#....................#.......#...............#....#.#..#....#.....#......................###..
.....#................#...#......#...#...............#..#...#.....#..............#..#.........#....#.....#..#............#......#..
........#..............#...........###.......................#.#...##.#..##........#....#.#....#......#...#..........#.............
......#.......#.............#..........#..........#.#.#.#...#.................#.......####.........................#....###.#......
....#...#...#.#..........#.......#.......#...#..##.#.###....###.......#...................................#..........#..#..#...#...
.#.......#....###...............#.............#....#..##..........#...........#...#.....##....#..#.................................
..#............#.#.........#....##.#.........#....#....#...#.#.#..#......#...##......#..........##.#...#............#....#.##.##.#.
......#........#..............##.##......#..........##.##.....##......#..#........................#..#.........##..#........#......
..................................##.....#.....#.......#....#.....#..........................###.#.#...........##........#.#.......
.#.......#........#...........#...........#.........#...........#...#.......#...#.#.......##.......................................
.##.#.......#........#.........#...#............#...........#.......#.#........#..#....#.......#...............#..........#..#.....
......#....#.......#...........#......#.................#...........##.......#...#.........#.#.##..#........#....#.......#..#......
.#........##.....##...............#......#....#..#..#..#.#...#....#............#.....#.............................#.........#.....
..#...#..........#................#.....#..#...#....................#.#..#............#.....#..##...........###..................#.
..........#..#..#........................#..#..#.........##.........#.......#......#.........#...............#...#......##.....#...
...#.....#...##........#....................................#..........#...#.......#..#....#.#..........#.#.#...#............#..#..
.....#........#.....#....................#........#....#...........#....#...#................#....................#........##......
.......#.#.#.......#.......##..........#...#..#..#......#...#.......##...##.....##.#.................#.........##...##.............
.............#..#.....#.#....##........#.....#.......#....#............##...#..#........................#......#......#......#.....
...#.....#......#.......#.#.............#...............#.....##.........#..#.........#.............#..#...#...#..........#...#....
........#.......................#........#.#.......##..#.##...###..#..#....#.#.....##........................#...................#.
............#..#.#.#......#...........................#.............#.#.......#..#..................#..........#..............#....
.#.....#..#..##..##............##.#........##..#..#...................#.......#...................#.......#.......##.#.............
.#.#..#...#.#.........#.#..#......#.........#.#..............#.#....#..#.....#....#.#.....................##........#..#....#....#.
..#....#.#........#..........#...#..#.....................#...#........#.....###.....................#.#..#..#..#...#.#..#.........
.#.......#..#....#...............#..#...............#......#................#................#......###....#.................#.....
....#.#..#...#..#....#..#..#...........................#..#...#.#.#................#..................#........#.......#.......#.#.
........#.........................#...#............#......#.#...........#.....#....#.......#.#.#...#....#.......#...#.....##.......
......#...#....#.......#.....##.#...............#................................#.........##.##......#.#.....#................#...
..#..#....#.#.#.......#......#.........#............#..........#............#..............#..#...#.#...##..#...#........#.#.#.....
..#.......#.....##......#........#....##..........................##...#.#.#.................................#.#.......#..##.......
....#..#...##............#....##...#......#.........................#......#.##.........##..........#..............##...#..........
...#...#...#........#..#......#...#.....#......................#.........#..#..........#.........##.........##.....................
.......#.............#.......#.......#....#.#........#.....#.#..#.#....................#..........#.#.....#.#.......#..#...........
.#............#..###..........#..............................#......##...................##............##...#.#......#...........#.
...#........................#..........##..#.......................#......#.........###...................#..#...................#.
.#......................#..##.#....#...........#..........#.......................#...#..#.....##....#.##......#...................
.#.........#.....#...#......##..#...#....#..#......................#.................#.#.............#.....#.....##......#.........
....#.........#........#.#.....#....#...#....#....................#.....#.......#........#.....#.....#.#..........#.......#......#.
...#..#........#......##.......................#.............#......##.........#.....#...#.#...#.#...........#.......##........#...
.......#.........##.....#.#.............#...#......#........#..#......#.........#............#.#.......#.#............#..##.#......
........#..#......#.#..#...#.....#..............................................##..#..#.....##..#......#..#.#...#.........#....#..
.#.#...#.....#.#................##..#.........#.#.##..#..........................#..#..........#.....##.###.#.........#....#.......
........#.#..............#......#....#..........#.....##....................#....#..........#.............#..#....#..........#.....
.......#...................##...#.#...#...#.#...###.##.##.........#............#.#.#..................#...#.#..##......#...#.......
....#.....#....###.....###........#......#.....#.....#..............................#..#........#....##........#...#..........#....
..###.#..#........#.....#...#.#.#.#....##.....#.#.........................#.##..#...#.....................##.....#........#.....##.
..#.#.#.##...#.#....#.##...#.......#.#......#.##.........#.............#.#.....#...........#.....##..........#........#....#.......
......##................#.#.......#............#..#......##.#.......................#........#.#.#...#.....#.........#...#.#.......
...................................................................................................................................";
        }
    }
}
